---
title: "Figure C - Estimate Accuracy"
author: "Joey Mays"
date: '2023-01-16'
output:
  pdf_document:
    toc: yes
  html_notebook:
    code_folding: show
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
    theme: flatly
    df_print: paged
  html_document:
    code_folding: show
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
    theme: flatly
    df_print: paged
editor_options:
  chunk_output_type: inline
  markdown:
    wrap: 72
---

# Setup

```{r message=FALSE}
library(karyotapR)
library(tidyverse)
library(ggplot2)
library(here)
library(cowplot)
library(ComplexHeatmap)
```

```{r}
set.seed(20221210)
```

```{r}
here::i_am("analysis-notebooks/Figure-C-sensitivity-specificity.Rmd")
```

```{r}
source(here("scripts", "gmm-calc-TPR.R"))
```

```{r}
dir.create(here("figures", "figure-c"), showWarnings = F, recursive = T)
fig.scalar = 1.375 #figure size scalar

theme_classic_custom <- theme_classic()
theme_classic_custom$axis.text <- element_text(size = 7)
theme_classic_custom$axis.title <- element_text(size = 8)
theme_classic_custom$legend.text <- element_text(size = 7)
theme_classic_custom$legend.title <- element_text(size = 8)
theme_classic_custom$strip.text <- element_text(size = 7)

theme_bw_custom <- theme_bw()
theme_bw_custom$axis.text <- element_text(size = 7)
theme_bw_custom$axis.title <- element_text(size = 8)
theme_bw_custom$legend.text <- element_text(size = 7)
theme_bw_custom$legend.title <- element_text(size = 8)
theme_bw_custom$strip.text <- element_text(size = 7)
```

# Load Data

```{r}
exp1 <- readRDS(file = here("datasets", "exp01.tapestriexperiment.RDS"))
#exp1.full <- readRDS(file = here("datasets", "exp01.full.tapestriexperiment.RDS"))
```

Move RPE1 to first position in factor for plotting order.

```{r}
colData(exp1)$cluster <- fct_relevel(colData(exp1)$cluster , "RPE1")
```

```{r}
bc.lut <- colData(exp1) %>% as_tibble() %>% select(cell.barcode, cluster)
```


# Smoothed Copy Number Heatmap

## Whole Chromosome

```{r}
row.annotation.data <- getTidyData(exp1, assay = "copyNumber") %>%
      dplyr::select("cell.barcode", "cluster") %>%
      dplyr::distinct() %>%
      dplyr::pull(cluster) %>%
      tibble::enframe(name = NULL, value = "cluster") %>%
      as.data.frame()

color.vector <- c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000")
names(color.vector) <- c("RPE1", "LS513", "SW48", "LoVo", "CL11")
color.list <- list(color.vector)
names(color.list)[1] <- "cluster"
row.annotation <- ComplexHeatmap::rowAnnotation(
  df = row.annotation.data, col = color.list, border = TRUE, na_col = "white",
  annotation_name_side = "top", annotation_name_gp = grid::gpar(fontsize = 0), show_legend = FALSE
)
```

```{r}
bottom.anno.scale <- c("1" = "#4C9940", "2" = "#ffffff", "3" = "#9D92EF", "4" = "#4C43C4")

bottom.annotation <- ComplexHeatmap::columnAnnotation(WGS = c(1,2,3,4, rep(2,19)), 
                                                      col = list(WGS = bottom.anno.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE)
```

### Pseudobulk

```{r}
pseudob.wc <- getTidyData(exp1, assay = "copyNumber") %>% group_by(feature.id, cluster, chr) %>% summarize(mean.cn = median(copyNumber), .groups = "drop") %>% group_by(cluster, chr) %>% summarize(median.cn = median(mean.cn), .groups = "drop") %>% pivot_wider(names_from = cluster, values_from = median.cn)

pb.scale <- circlize::colorRamp2(c(1, 1.8, 2, 2.2, 3, 4),
               c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c"))
# pb.scale <- circlize::colorRamp2(c(1, 2, 3, 4), 
#                 c("#2c7bb6", "#ffffff", "#fdae61", "#d7191c"))
```

```{r}
exp1.wc.smoothcn.heatmap <- 
    assayHeatmap(exp1, alt.exp = "smoothedCopyNumberByChr", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", column_title_rot = 0, color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number", bottom_annotation = bottom.annotation)
exp1.wc.smoothcn.heatmap
```

```{r}
saveRDS(object = exp1.wc.smoothcn.heatmap, file = here("figures", "figure-c", "exp01.wc.smooth.heatmap.RDS"))
```

```{r}
# Figure 2B
pdf(file = here("figures", "figure-c", "exp01.wc.smooth.heatmap.pdf"), 
    width = 8.53, height = 4)
assayHeatmap(exp1, alt.exp = "smoothedCopyNumberByChr", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", annotate.row.by = "cluster", column_title_rot = 0, color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number", bottom_annotation = bottom.annotation)
dev.off()
```

```{r}
wgs.tab <- read.table(here("datasets", "wgs-chr.txt"), sep = '\t', header = T)
```

```{r}
exp1.1 <- exp1[,pull(filter(bc.lut, cluster == "RPE1"), cell.barcode)]
exp1.1.hm <- assayHeatmap(exp1.1, alt.exp = "smoothedCopyNumberByChr", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", column_title_rot = 0, color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number", raster_quality = 5, raster_by_magick = T)

rpe1.wgs.anno <- ComplexHeatmap::columnAnnotation(WGS = wgs.tab$RPE1, 
                                                      col = list(WGS = bottom.anno.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"), annotation_legend_param = list(labels = 1:4, at = 1:4))
rpe1.pb.anno <- ComplexHeatmap::columnAnnotation(pb = pseudob.wc$RPE1, 
                                                      col = list(pb = pb.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"))
```

```{r}
exp1.2 <- exp1[,pull(filter(bc.lut, cluster == "LS513"), cell.barcode)]
exp1.2.hm <- assayHeatmap(exp1.2, alt.exp = "smoothedCopyNumberByChr", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", column_title_rot = 0, color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number", raster_quality = 5, raster_by_magick = T)

ls513.wgs.anno <- ComplexHeatmap::columnAnnotation(WGS = wgs.tab$LS513, 
                                                      col = list(WGS = bottom.anno.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                   simple_anno_size = unit(3, "mm"))
ls513.pb.anno <- ComplexHeatmap::columnAnnotation(pb = pseudob.wc$LS513, 
                                                      col = list(pb = pb.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"))
```

```{r}
exp1.3 <- exp1[,pull(filter(bc.lut, cluster == "SW48"), cell.barcode)]
exp1.3.hm <- assayHeatmap(exp1.3, alt.exp = "smoothedCopyNumberByChr", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", column_title_rot = 0, color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number", raster_quality = 5, raster_by_magick = T)

sw48.wgs.anno <- ComplexHeatmap::columnAnnotation(WGS = wgs.tab$SW48, 
                                                      col = list(WGS = bottom.anno.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"))
sw48.pb.anno <- ComplexHeatmap::columnAnnotation(pb = pseudob.wc$SW48, 
                                                      col = list(pb = pb.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"))
```

```{r}
exp1.4 <- exp1[,pull(filter(bc.lut, cluster == "LoVo"), cell.barcode)]
exp1.4.hm <- assayHeatmap(exp1.4, alt.exp = "smoothedCopyNumberByChr", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", column_title_rot = 0, color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number", raster_quality = 5, raster_by_magick = T)

lovo.wgs.anno <- ComplexHeatmap::columnAnnotation(WGS = wgs.tab$LOVO, 
                                                      col = list(WGS = bottom.anno.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE, 
                                                  simple_anno_size = unit(3, "mm"))
lovo.pb.anno <- ComplexHeatmap::columnAnnotation(pb = pseudob.wc$LoVo, 
                                                      col = list(pb = pb.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"))
```

```{r}
exp1.5 <- exp1[,pull(filter(bc.lut, cluster == "CL11"), cell.barcode)]
exp1.5.hm <- assayHeatmap(exp1.5, alt.exp = "smoothedCopyNumberByChr", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", column_title_rot = 0, color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number", raster_quality = 5, raster_by_magick = T)

cl11.wgs.anno <- ComplexHeatmap::columnAnnotation(WGS = wgs.tab$CL11, 
                                                      col = list(WGS = bottom.anno.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE, 
                                                  simple_anno_size = unit(3, "mm"))
cl11.pb.anno <- ComplexHeatmap::columnAnnotation(pb = pseudob.wc$CL11, 
                                                      col = list(pb = pb.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"))
```

```{r}
ht.list <- exp1.1.hm %v% rpe1.pb.anno %v% rpe1.wgs.anno %v%
exp1.2.hm %v% ls513.pb.anno %v% ls513.wgs.anno %v% 
exp1.3.hm %v% sw48.pb.anno %v% sw48.wgs.anno %v% 
exp1.4.hm %v% lovo.pb.anno %v% lovo.wgs.anno %v% 
exp1.5.hm %v% cl11.pb.anno %v% cl11.wgs.anno
draw(ht.list, ht_gap = unit(c(1,1,4,1,1,4,1,1,4,1,1,4,1,1), "mm"))
```

```{r}
pdf(file = here("figures", "figure-c", "exp01.wc.smooth.heatmap.pb.pdf"), 
    width = 7.90, height = 3.75)
draw(ht.list, ht_gap = unit(c(1,1,4,1,1,4,1,1,4,1,1,4,1,1), "mm"))
dev.off()
```

```{r}
ht.list.hm <- exp1.1.hm %v% exp1.2.hm %v% exp1.3.hm %v% exp1.4.hm %v% exp1.5.hm 
draw(ht.list.hm, ht_gap = unit(c(12, 12, 12, 12), "mm"))
```

```{r}
pdf(file = here("figures", "figure-c", "exp01.wc.smooth.heatmap.spaced.pdf"), 
    width = 7.90, height = 3.75)
draw(ht.list.hm, ht_gap = unit(c(12, 12, 12, 12), "mm"), use_raster = T, raster_quality = 7)
dev.off()
```

### GMM Heatmap

```{r}
gmm.anno.scale <- c("1" = "#2c7bb6", "2" = "#ffffff", "3" = "#fdae61", "4" = "#d7191c", "5" = "#d7191c", "6" = "#d7191c")
```

```{r}
exp1.wc.gmm.heatmap <- 
    assayHeatmap(exp1, alt.exp = "smoothedCopyNumberByChr", assay = "gmmCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", column_title_rot = 0, color.custom = gmm.anno.scale, heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number")
exp1.wc.gmm.heatmap
```

```{r}
pdf(file = here("figures", "figure-c", "exp01.wc.gmm.heatmap.pdf"), 
    width = 4.2, height = 2.6)
draw(exp1.wc.gmm.heatmap, use_raster = T, raster_quality = 7)
dev.off()
```


### Raw Matrix

```{r}
raw.ploidy.wc <- round(t(assay(altExp(exp1, "smoothedCopyNumberByChr"), "smoothedCopyNumber")), 3)
colnames(raw.ploidy.wc) <- paste0("chr", colnames(raw.ploidy.wc))
raw.ploidy.wc <- cbind(colData(exp1)[,"cluster", drop = F], raw.ploidy.wc) 
raw.ploidy.wc <- raw.ploidy.wc %>% as.data.frame() %>% rownames_to_column("cell.barcode")
```

```{r}
write.csv(x = raw.ploidy.wc, file = here("figures", "figure-c", "exp01.wc.smooth.heatmap.raw.csv"), 
          quote = F, row.names = F)
```

## Chromosome Arms

```{r}
bottom.anno.scale <- c("1" = "#4C9940", "2" = "#ffffff", "3" = "#9D92EF", "4" = "#4C43C4")

bottom.annotation.arm <- ComplexHeatmap::columnAnnotation(WGS = c(1,2,3,4, rep(2,37)), 
                                                      col = list(WGS = bottom.anno.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE)
```

```{r}
exp1.arm.smoothcn.heatmap <- 
assayHeatmap(exp1, alt.exp = "smoothedCopyNumberByArm", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number", bottom_annotation = bottom.annotation.arm)
exp1.arm.smoothcn.heatmap
```
```{r}
saveRDS(object = exp1.arm.smoothcn.heatmap, file = here("figures", "figure-c", "exp01.arm.smooth.heatmap.RDS"))
```

```{r}
pdf(file = here("figures", "figure-c", "exp01.arm.smooth.heatmap.pdf"), 
    width = 8.53, height = 4)
assayHeatmap(exp1, alt.exp = "smoothedCopyNumberByArm", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number", bottom_annotation = bottom.annotation.arm)
dev.off()
```

### Pseudobulk

```{r}
pseudob.arm <- getTidyData(exp1, assay = "copyNumber") %>% group_by(feature.id, cluster, arm) %>% summarize(mean.cn = median(copyNumber), .groups = "drop") %>% group_by(cluster, arm) %>% summarize(median.cn = median(mean.cn), .groups = "drop") %>% pivot_wider(names_from = cluster, values_from = median.cn)

pb.scale <- circlize::colorRamp2(c(1, 1.8, 2, 2.2, 3, 4),
               c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c"))
# pb.scale <- circlize::colorRamp2(c(1, 2, 3, 4), 
#                 c("#2c7bb6", "#ffffff", "#fdae61", "#d7191c"))
```

```{r}
wgs.tab.arm <- read.table(here("datasets", "wgs-arm.txt"), sep = '\t', header = T)
```

```{r}
exp1.arm.1.hm <- assayHeatmap(exp1.1, alt.exp = "smoothedCopyNumberByArm", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", column_title_rot = 90, color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number")

rpe1.wgs.arm.anno <- ComplexHeatmap::columnAnnotation(WGS = wgs.tab.arm$RPE1, 
                                                      col = list(WGS = bottom.anno.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"), annotation_legend_param = list(labels = 1:4, at = 1:4))
rpe1.pb.arm.anno <- ComplexHeatmap::columnAnnotation(pb = pseudob.arm$RPE1, 
                                                      col = list(pb = pb.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"))
```

```{r}
exp1.arm.2.hm <- assayHeatmap(exp1.2, alt.exp = "smoothedCopyNumberByArm", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", column_title_rot = 90, color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number")

ls513.wgs.arm.anno <- ComplexHeatmap::columnAnnotation(WGS = wgs.tab.arm$LS513, 
                                                      col = list(WGS = bottom.anno.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                   simple_anno_size = unit(3, "mm"))
ls513.pb.arm.anno <- ComplexHeatmap::columnAnnotation(pb = pseudob.arm$LS513, 
                                                      col = list(pb = pb.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"))
```

```{r}
exp1.arm.3.hm <- assayHeatmap(exp1.3, alt.exp = "smoothedCopyNumberByArm", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", column_title_rot = 90, color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number")

sw48.wgs.arm.anno <- ComplexHeatmap::columnAnnotation(WGS = wgs.tab.arm$SW48, 
                                                      col = list(WGS = bottom.anno.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"))
sw48.pb.arm.anno <- ComplexHeatmap::columnAnnotation(pb = pseudob.arm$SW48, 
                                                      col = list(pb = pb.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"))
```

```{r}
exp1.arm.4.hm <- assayHeatmap(exp1.4, alt.exp = "smoothedCopyNumberByArm", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", column_title_rot = 90, color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number")

lovo.wgs.arm.anno <- ComplexHeatmap::columnAnnotation(WGS = wgs.tab.arm$LOVO, 
                                                      col = list(WGS = bottom.anno.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE, 
                                                  simple_anno_size = unit(3, "mm"))
lovo.pb.arm.anno <- ComplexHeatmap::columnAnnotation(pb = pseudob.arm$LoVo, 
                                                      col = list(pb = pb.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"))
```

```{r}
exp1.arm.5.hm <- assayHeatmap(exp1.5, alt.exp = "smoothedCopyNumberByArm", assay = "smoothedCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", column_title_rot = 90, color.custom = circlize::colorRamp2(c(1, 1.5, 2, 2.5, 3, 4), c("#2c7bb6", "#ffffff", "#ffffff", "#ffffff", "#fdae61", "#d7191c")), heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number")

cl11.wgs.arm.anno <- ComplexHeatmap::columnAnnotation(WGS = wgs.tab.arm$CL11, 
                                                      col = list(WGS = bottom.anno.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE, 
                                                  simple_anno_size = unit(3, "mm"))
cl11.pb.arm.anno <- ComplexHeatmap::columnAnnotation(pb = pseudob.arm$CL11, 
                                                      col = list(pb = pb.scale),  annotation_name_side = "left", 
                                                      annotation_name_gp = grid::gpar(fontsize = 0), border = TRUE,
                                                  simple_anno_size = unit(3, "mm"))
```

```{r}
ht.list.arm <- exp1.arm.1.hm %v% rpe1.pb.arm.anno %v% rpe1.wgs.arm.anno %v%
exp1.arm.2.hm %v% ls513.pb.arm.anno %v% ls513.wgs.arm.anno %v% 
exp1.arm.3.hm %v% sw48.pb.arm.anno %v% sw48.wgs.arm.anno %v% 
exp1.arm.4.hm %v% lovo.pb.arm.anno %v% lovo.wgs.arm.anno %v% 
exp1.arm.5.hm %v% cl11.pb.arm.anno %v% cl11.wgs.arm.anno
draw(ht.list.arm, ht_gap = unit(c(1,1,4,1,1,4,1,1,4,1,1,4,1,1), "mm"))
```

```{r}
pdf(file = here("figures", "figure-c", "exp01.arm.smooth.heatmap.pb.pdf"), 
    width = 7.90, height = 3.75)
draw(ht.list.arm, ht_gap = unit(c(1,1,4,1,1,4,1,1,4,1,1,4,1,1), "mm"))
dev.off()
```

```{r}
ht.arm.list.hm <- exp1.arm.1.hm %v% exp1.arm.2.hm %v% exp1.arm.3.hm %v% exp1.arm.4.hm %v% exp1.arm.5.hm 
draw(ht.arm.list.hm, ht_gap = unit(c(12, 12, 12, 12), "mm"))
```

```{r}
pdf(file = here("figures", "figure-c", "exp01.arm.smooth.heatmap.spaced.pdf"), 
    width = 7.90, height = 3.75)
draw(ht.arm.list.hm, ht_gap = unit(c(12, 12, 12, 12), "mm"), use_raster = T, raster_quality = 7)
dev.off()
```

### GMM Heatmap

```{r}
gmm.anno.scale <- c("1" = "#2c7bb6", "2" = "#ffffff", "3" = "#fdae61", "4" = "#d7191c", "5" = "#d7191c", "6" = "#d7191c")
```

```{r}
exp1.arm.gmm.heatmap <- 
    assayHeatmap(exp1, alt.exp = "smoothedCopyNumberByArm", assay = "gmmCopyNumber", split.col.by = "feature.id", split.row.by = "cluster", column_title_rot = 90, color.custom = gmm.anno.scale, heatmap_legend_param = list(title_position = "lefttop-rot", border = "black"), name = "Copy Number")
exp1.arm.gmm.heatmap
```

```{r}
pdf(file = here("figures", "figure-c", "exp01.arm.gmm.heatmap.pdf"), 
    width = 7.90, height = 2.75)
draw(exp1.arm.gmm.heatmap, use_raster = T, raster_quality = 7)
dev.off()
```

### Raw Matrix

```{r}
raw.ploidy.arm <- round(t(assay(altExp(exp1, "smoothedCopyNumberByArm"), "smoothedCopyNumber")), 3)
raw.ploidy.arm <- cbind(colData(exp1)[,"cluster", drop = F], raw.ploidy.arm) 
raw.ploidy.arm <- raw.ploidy.arm %>% as.data.frame() %>% rownames_to_column("cell.barcode")
```

```{r}
write.csv(x = raw.ploidy.arm, file = here("figures", "figure-c", "exp01.arm.smooth.heatmap.raw.csv"), 
          quote = F, row.names = F)
```

# GMM Plots

```{r}
gmm1 <- plotCopyNumberGMM(exp1, feature.id = 1, draw.boundaries = T) +     
    theme_classic_custom +
    theme(legend.position = "none", panel.grid.minor = element_blank(), panel.grid.major.y = element_blank(),
          plot.margin = unit(c(0, 0, 5.5, 5.5), "pt"), axis.title.x = element_blank()) + 
    labs(title = NULL, color = "Copy Number Component") +
    scale_y_continuous(expand = c(0,0,0,0.05)) +
    scale_x_continuous(expand = c(0,0,0,0), breaks = 1:10) +
    annotate("text", x = 9, y = 0.95, label = "Chr 1", size = 7/.pt) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000", "grey"))

gmm2 <- plotCopyNumberGMM(exp1, feature.id = 13, draw.boundaries = T) +
        theme_classic_custom +
        theme(legend.position = "none", panel.grid.minor = element_blank(), panel.grid.major.y = element_blank(),
          plot.margin = unit(c(0, 5.5, 5.5, 0), "pt"), axis.title = element_blank(), axis.text.y = element_blank()) + 
    labs(title = NULL, color = "Copy Number Component") +
    scale_y_continuous(expand = c(0,0,0,0.05)) +
    scale_x_continuous(expand = c(0,0,0,0), breaks = 1:10) +
        annotate("text", x = 9, y = 0.95, label = "Chr 13", size = 7/.pt) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000", "grey"))

gmm3 <- plotCopyNumberGMM(exp1, feature.id = 22, draw.boundaries = T) +
        theme_classic_custom +
        theme(legend.position = "none", panel.grid.minor = element_blank(), panel.grid.major.y = element_blank(),
          plot.margin = unit(c(0, 0, 5.5, 5.5), "pt")) + 
    labs(title = NULL, color = "Copy Number Component", x = "Copy Number Score") +
    scale_y_continuous(expand = c(0,0,0,0.05)) +
    scale_x_continuous(expand = c(0,0,0,0), breaks = 1:10) +
    annotate("text", x = 9, y = 0.95, label = "Chr 22", size = 7/.pt) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000", "grey"))

gmm4 <- plotCopyNumberGMM(exp1, feature.id = "X", draw.boundaries = T) +
        theme_classic_custom +
    theme(legend.position = "none", panel.grid.minor = element_blank(), panel.grid.major.y = element_blank(),
          plot.margin = unit(c(0, 5.5, 5.5, 0), "pt"), axis.text.y = element_blank(), axis.title.y = element_blank()) + 
    labs(title = NULL, color = "Copy Number Component", x = "Copy Number Score") +
    scale_y_continuous(expand = c(0,0,0,0.05)) +
    scale_x_continuous(expand = c(0,0,0,0), breaks = 1:10) +
    annotate("text", x = 9, y = 0.95, label = "Chr X", size = 7/.pt) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000", "grey"))

gmm.legend <- get_legend(gmm1 + theme(legend.box.margin = margin(0, 0, 5, 0), legend.position = "top") + guides(color = guide_legend(nrow = 1)))

gmm.grid.1 <- plot_grid(plotlist = list(gmm1, gmm2, gmm3, gmm4), ncol = 2, align = "hv", axis = "lrtb")
gmm.example.plot <- plot_grid(plotlist = list(gmm.legend, gmm.grid.1), ncol = 1, rel_heights = c(0.2, 1))
gmm.example.plot
```

```{r}
saveRDS(object = gmm.example.plot, file = here("figures", "figure-c", "exp01.gmm.example.plot.RDS"))
```


# Sensitivity

## Whole Chromosome

### Bar Chart

Get sensitivity by comparing CN calls to expected values (2 for diploid.)

```{r}
rpe1.data <- getTidyData(exp1, "smoothedCopyNumberByChr", "gmmCopyNumber") %>% filter(cluster == "RPE1", feature.id != 10) %>% select(!c("total.reads", "cluster"))
rpe1.data$known.ploidy <- 2
rpe1.data.results <- rpe1.data %>% group_by(cell.barcode, feature.id) %>% summarise(cn.concordance = gmmCopyNumber == known.ploidy, .groups = "drop") %>% group_by(feature.id) %>% dplyr::count(cn.concordance) %>% mutate(pct.concordance = round(n*100/sum(n), 1)) %>% filter(cn.concordance == TRUE) %>% print()

sum(rpe1.data.results$pct.concordance >=75.0)
nrow(rpe1.data.results)

n.probes <- fct_count(rowData(exp1)$chr)
colnames(n.probes) <- c("feature.id", "n.probes")
rpe1.data.results <- rpe1.data.results %>% left_join(n.probes, by = "feature.id")
```

```{r}
wc.sensitivity <- 
rpe1.data.results %>% 
    ggplot(aes(x=feature.id, y=pct.concordance)) +
    geom_col(color = "black", fill = "#C6DEA6", width = .75) +
    coord_cartesian(ylim = c(0,100)) +
    scale_y_continuous(expand = c(0,0,0,5), breaks = seq(0,100,20), minor_breaks = seq(0,100,10)) +
    labs(y = "Sensitivity (%)", x = "Chromosome") +
    geom_text(aes(label=round(pct.concordance,0)), vjust = -1, size = 7/.pt) +
    theme_bw_custom +
    theme(panel.grid.major.x = element_blank(), panel.border = element_blank(), axis.line = element_line()) +
    geom_hline(yintercept = mean(rpe1.data.results$pct.concordance), linetype = "dashed", alpha = 0.7) +
    annotate("text", x = 21, y = 95, size = 7/.pt, label = paste0("avg: ", round(mean(rpe1.data.results$pct.concordance), 0), "%"))
wc.sensitivity
```

```{r}
saveRDS(wc.sensitivity, file = here("figures", "figure-c", "exp01.rpe1.accuracy.wc.RDS"))
```

```{r}
saveRDS(rpe1.data.results, file = here("datasets", "rpe1.accuracy.rates.RDS"))
```

#### Cross Validation

```{r}
rpe1.bcs <- colData(exp1) %>% as_tibble %>% filter(cluster == "RPE1") %>% pull(cell.barcode)
rpe1.bcs.scrambled <- sample(rpe1.bcs, size = length(rpe1.bcs), replace = F)
rpe1.index <- cut_number(seq_along(rpe1.bcs.scrambled), n = 5)
rpe1.index <- rpe1.index %>% fct_recode("fold1" = "[1,119]", "fold2" = "(119,237]", "fold3" = "(237,355]", "fold4" = "(355,473]", "fold5" = "(473,591]")
cv.folds <- data.frame(cell.barcode = rpe1.bcs.scrambled, cv.fold = rpe1.index)
```

```{r}
exp1.cv <- exp1
control.copy.number <- generateControlCopyNumberTemplate(exp1, copy.number = 2, "RPE1")
control.copy.number["chr10q", "copy.number"] <- 3
```

```{r}
cv.results <- map(levels(cv.folds$cv.fold), function(x){
    
    training.bcs <- cv.folds %>% filter(cv.fold != x) %>% pull(cell.barcode)
    exp1.cv <- calcGMMCopyNumber(exp1.cv, cell.barcodes = training.bcs, control.copy.number = control.copy.number)
    
    rpe1.cv.data <- getTidyData(exp1.cv, "smoothedCopyNumberByChr", "gmmCopyNumber") %>% filter(cluster == "RPE1", feature.id != 10, !cell.barcode %in% training.bcs) %>% select(!c("total.reads", "cluster"))
    rpe1.cv.data$known.ploidy <- 2
    rpe1.cv.data.results <- rpe1.cv.data %>% group_by(cell.barcode, feature.id) %>% summarise(cn.concordance = gmmCopyNumber == known.ploidy, .groups = "drop") %>% group_by(feature.id) %>% dplyr::count(cn.concordance) %>% mutate(pct.concordance = round(n*100/sum(n), 1)) %>% filter(cn.concordance == TRUE) %>% add_column(test.fold = x)
    
}) %>% list_rbind() %>% left_join(n.probes, by = "feature.id")
```

```{r}
cv.results %>% 
    ggplot(aes(x = feature.id, y = pct.concordance)) +
    ggdist::stat_pointinterval(.width = c(1), linewidth = 2, point_size = 1, point_interval = "mean_qi") + 
    geom_point(position = position_nudge(x=-0.3), alpha = 0.5, size = 1) +
    geom_point(data = rpe1.data.results, aes(x=feature.id, y=pct.concordance), inherit.aes = F, pch = 4, color = "red", position = position_nudge(x=0.3)) +
    theme_bw_custom +
    scale_y_continuous(limits = c(34, 100)) +
    labs(y = "Sensitivity (%)", x = "Chromosome")
```

```{r}
wc.sensitivity.mad <- 
cv.results %>% group_by(feature.id) %>% summarize(mean.pct = mean(pct.concordance), mad = mad(pct.concordance), mean.ad = DescTools::MeanAD(pct.concordance)) %>% print() %>% 
    ggplot(aes(x = feature.id, y = mean.pct)) + 
    ggdist::geom_pointinterval(aes(ymin = mean.pct - mean.ad, ymax = mean.pct + mean.ad)) +
    theme_classic_custom + 
    theme(panel.grid.major = element_line()) +
    scale_y_continuous(limits = c(40, 100), expand = c(0,0,0,0)) +
    labs(y = "Sensitivity (%)", x = "Chromosome") + 
    geom_hline(yintercept = mean(cv.results$pct.concordance), linetype = "dashed", alpha = 0.7) +
    annotate("text", x = 21, y = 95, size = 7/.pt, label = paste0("avg: ", round(mean(cv.results$pct.concordance), 0), "%"))
wc.sensitivity.mad
```

```{r}
saveRDS(wc.sensitivity.mad, file = here("figures", "figure-c", "exp01.rpe1.accuracy.wc.mad.RDS"))
```


### Empirical Sensitivity for Cancer Cell CNVs

Assuming that CNVs are clonal, what is the sensitivity for detection of CNVs in cancer cell lines, and do they match up with theoretical sensitivity expectations?

LS513 - 1q, 5, 7, 9, 13x2, XY
LoVo - 5p, 7, 12, 15, XY
CL11 - -6, 7x2, -18, XY
SW48 - 7, 14

```{r}
exp1.tpr <- calcTruePosRate(exp1, "chr") %>%  select(feature.id, cn.sim.class, true.pos.p)
exp1.tpr$feature.id <- as.character(exp1.tpr$feature.id)
exp1.tpr$true.pos.p <- round(exp1.tpr$true.pos.p * 100,1)
exp1.tpr$cn.sim.class <- factor(exp1.tpr$cn.sim.class, levels = levels(exp1.tpr$cn.sim.class), labels = c(1:6))
exp1.tpr$cn.sim.class <- as.numeric(as.character(exp1.tpr$cn.sim.class))
colnames(exp1.tpr)[2:3] <- c("event", "sensitivity.sim")
```

```{r}
empirical.sim.comparison <- function(cell.data, cell.lut){
    
    cell.data <- cell.data %>% filter(feature.id %in% cell.lut$feature.id) %>% left_join(cell.lut, by = 'feature.id') %>% mutate(known.cn = ifelse(is.na(known.cn), 2, known.cn)) %>% mutate(feature.id = factor(feature.id, labels = unique(cell.lut$feature.id)))
    
    cell.data.results <- cell.data %>% group_by(cell.barcode, feature.id) %>% summarise(cn.concordance = gmmCopyNumber == known.cn, .groups = "drop") %>% group_by(feature.id) %>% dplyr::count(cn.concordance) %>% mutate(sensitivity.emp = round(n*100/sum(n), 1)) %>% filter(cn.concordance == TRUE) %>% select(feature.id, n, sensitivity.emp) %>% left_join(cell.lut, by = "feature.id")
    
    cell.data.results %>% left_join(exp1.tpr, by = c("known.cn" = "event", "feature.id")) %>% select(feature.id, known.cn, sensitivity.emp, sensitivity.sim)
    
}
```


```{r}
ls513.data <- getTidyData(exp1, "smoothedCopyNumberByChr", "gmmCopyNumber") %>% filter(cluster == "LS513") %>% select(!c("total.reads", "cluster"))

ls513.lut <- data.frame(feature.id = c(5,7,9,13,"X"),
                        known.cn = c(3,3,3,4,1))

empirical.sim.comparison(ls513.data, ls513.lut)

```


```{r}
lovo.data <- getTidyData(exp1, "smoothedCopyNumberByChr", "gmmCopyNumber") %>% filter(cluster == "LoVo") %>% select(!c("total.reads", "cluster"))

lovo.lut <- data.frame(feature.id = c(7,12,15,"X"),
                        known.cn = c(3,3,3,1))

empirical.sim.comparison(lovo.data, lovo.lut)
```

```{r}
cl11.data <- getTidyData(exp1, "smoothedCopyNumberByChr", "gmmCopyNumber") %>% filter(cluster == "CL11") %>% select(!c("total.reads", "cluster"))

cl11.lut <- data.frame(feature.id = c(6, 7, 18, 22, "X"),
                        known.cn = c(1, 4, 1, 1, 1))

empirical.sim.comparison(cl11.data, cl11.lut)
```

```{r}
sw48.data <- getTidyData(exp1, "smoothedCopyNumberByChr", "gmmCopyNumber") %>% filter(cluster == "SW48") %>% select(!c("total.reads", "cluster"))

sw48.lut <- data.frame(feature.id = c("7", "14"),
                        known.cn = c(3, 3))

empirical.sim.comparison(sw48.data, sw48.lut)
```

```{r}
empirical.sensitivity.list <- list(ls513 = empirical.sim.comparison(ls513.data, ls513.lut), 
     lovo = empirical.sim.comparison(lovo.data, lovo.lut),
     cl11 = empirical.sim.comparison(cl11.data, cl11.lut), 
     sw48 = empirical.sim.comparison(sw48.data, sw48.lut))
```


### Linear Regression

```{r}
mod <- (lm(pct.concordance ~ log(n.probes), rpe1.data.results))
plot(mod$residuals) 
plot(density(mod$residuals))
summary(mod)
rsq <- summary(mod)$r.squared %>% round(.,2) %>% paste0("R-sq: ", .) %>% print()
```

```{r}
wc.sens.lm <- 
ggplot(rpe1.data.results, aes(x=n.probes, y=pct.concordance)) +
    geom_smooth(method = "lm", se = F, color = "#C6DEA6") + 
    geom_point() +
    ggrepel::geom_text_repel(aes(label = feature.id), max.overlaps = 12, size = 7/.pt) + 
    labs(y= "Sensitivity (%)", x = "Number of Probes per Chromosome") +
    theme_classic_custom + 
    theme(panel.grid.major = element_line()) +
    scale_y_continuous(limits = c(30,100), expand = c(0,0)) +
    scale_x_continuous(trans = "log", limits = c(4,24), breaks = seq(4,24,2)) +
    annotate("text", x = 4.1, y = 97, label = rsq, hjust = 0, size = 7/.pt)
wc.sens.lm
```

```{r}
saveRDS(wc.sens.lm, file = here("figures", "figure-c", "exp01.rpe1.accuracy.wc.regression.RDS"))
```

```{r}
cv.results.summary <- cv.results %>% group_by(feature.id, n.probes) %>% summarize(mean.pct = mean(pct.concordance), .groups = "drop")
```

```{r}
mod2 <- (lm(mean.pct ~ log(n.probes), cv.results.summary))
plot(mod2$residuals) 
plot(density(mod2$residuals))
summary(mod2)
rsq2 <- summary(mod2)$r.squared %>% round(.,2) %>% paste0("R-sq: ", .) %>% print()
```

```{r}
ggplot(cv.results.summary, aes(x=n.probes, y=mean.pct)) +
    geom_smooth(method = "lm", se = F, color = "#C6DEA6") + 
    geom_point() +
    ggrepel::geom_text_repel(aes(label = feature.id), max.overlaps = 12, size = 7/.pt) + 
    labs(y= "Mean Sensitivity (%)", x = "Number of Probes per Chromosome") +
    theme_classic_custom + 
    theme(panel.grid.major = element_line()) +
    scale_y_continuous(limits = c(30,100), expand = c(0,0)) +
    scale_x_continuous(trans = "log", limits = c(4,24), breaks = seq(4,24,2)) +
    annotate("text", x = 4.1, y = 97, label = rsq2, hjust = 0, size = 7/.pt)
```

### Theoretical Sensitivity

We can include chr 10 here because its the simulated version of chr10 where probes targeting chr10q are scaled appropriately to be diploid in the simulated CN=2 cells.
Component 6 is excluded because it has no upper bound, so it appears higher, but is really a stand-in for CN=6+. 

```{r}
exp1.gmm.metrics <- calcTruePosRate(exp1, "chr") %>% filter(cn.sim.class != "sim_cn6")
exp1.gmm.metrics <- exp1.gmm.metrics %>% left_join(n.probes, by = "feature.id")
exp1.gmm.metrics <- exp1.gmm.metrics %>% mutate(false.neg.p = false.neg.p * 100, true.pos.p = true.pos.p * 100)
```

```{r}
exp1.gmm.metrics.avg <- exp1.gmm.metrics %>% group_by(cn.sim.class) %>% summarize(mean.tpr = mean(true.pos.p), .groups = "drop") %>% print()
```


```{r}
tpr.wc.bars <- 
ggplot(exp1.gmm.metrics, aes(x = feature.id, y = true.pos.p)) +
    geom_col(aes(fill = cn.sim.class), color = "black", width = 0.85) +
    facet_wrap(cn.sim.class ~., ncol = 1) +
    theme_classic_custom +
    theme(legend.position = "none", panel.grid.major.y = element_line(), 
          strip.background = element_blank()) +
    scale_fill_manual(values = c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000")) +
    labs(x = "Chromosome", y = "Theoretical Sensitivity (%)") +
    scale_y_continuous(breaks = c(0, 50, 100), expand = c(0,0,0,0)) +
    geom_text(aes(label=round(true.pos.p,0)), vjust = -1, size = 6/.pt) +
    geom_text(data = exp1.gmm.metrics.avg, aes(label = glue::glue("avg: {round(mean.tpr, 0)}%"), x = 22, y = 140), size = 6/.pt, inherit.aes = F)
tpr.wc.bars
```

```{r}
saveRDS(tpr.wc.bars, file = here("figures", "figure-c", "exp01.wc.theoretical.tpr.bars.RDS"))
```

```{r}
tpr.wc.nprobes <- 
ggplot(exp1.gmm.metrics, aes(x=n.probes, y=true.pos.p, color = cn.sim.class)) +
    geom_point(alpha = 0.5, position = position_jitter(width = 0.25)) + 
    theme_classic_custom +
    theme(legend.position = "top", panel.grid.major = element_line()) +
    theme(legend.box.margin = margin(0, 10, 0, 10), legend.margin = margin(0), plot.margin = unit(c(0, 5.5, 5.5, 5.5), "pt")) +
    geom_smooth(se = F, span = 1, linewidth = 0.75) +
    geom_smooth(data = rpe1.data.results, aes(x=n.probes, y=pct.concordance), linewidth = 0.75,
                color = "black", inherit.aes = F, se = F, span = 1, linetype = "dashed", alpha = 0.5) +
       geom_smooth(data = cv.results.summary, aes(x=n.probes, y=mean.pct), linewidth = 0.75,
                color = "red", inherit.aes = F, se = F, span = 1, linetype = "dashed", alpha = 0.5) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000"), labels = 1:5) +
    labs(x = "Number of Probes", y = "Theoretical Sensitivity (%)", color = "Copy Number") +
    scale_x_continuous(limits = c(4,24), breaks = seq(4,24,2)) +
    scale_y_continuous(limits = c(15, 100), expand = c(0,0,0,1))
tpr.wc.nprobes
```

```{r}
saveRDS(tpr.wc.nprobes, file = here("figures", "figure-c", "exp01.wc.theoretical.tpr.RDS"))
```

Correlation between theoretical true positive rate and actual true positive rate is high.

```{r}
combined.data <- inner_join(exp1.gmm.metrics, rpe1.data.results, by = "feature.id") %>% filter(cn.sim.class == "sim_cn2")
cor(combined.data$pct.concordance, combined.data$true.pos.p)
```

```{r}
saveRDS(exp1.gmm.metrics, file = here("datasets", "exp1.gmm.metrics.RDS"))
```

### Specificity

true neg / (true neg + false pos)

there are no true negatives or false positives for CN = 2


```{r}
exp1.gmm.specificity <- calcTrueNegRate(exp1) %>% mutate(tnr = tnr * 100) %>% filter(cn.sim.class != "sim_cn6")
exp1.gmm.specificity <- exp1.gmm.specificity %>% left_join(n.probes, by = "feature.id")

ggplot(exp1.gmm.specificity, aes(x = feature.id, y = tnr)) +
    geom_col(aes(fill = cn.sim.class), color = "black", width = 0.85) +
    facet_wrap(cn.sim.class ~., ncol = 1) +
    theme_classic_custom +
    theme(legend.position = "none", panel.grid.major.y = element_line(), 
          strip.background = element_blank()) +
    scale_fill_manual(values = c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000")) +
    labs(x = "Chromosome", y = "Theoretical Specificity (%)") +
    scale_y_continuous(breaks = c(0, 50, 100), expand = c(0,0,0,25)) +
    geom_text(aes(label=round(tnr,0)), vjust = -1, size = 6/.pt)
```

```{r}
ggplot(exp1.gmm.specificity, aes(x=n.probes, y=tnr, color = cn.sim.class)) +
    geom_point(alpha = 0.5, position = position_jitter(width = 0.25)) + 
    theme_classic_custom +
    theme(legend.position = "top", panel.grid.major = element_line()) +
    theme(legend.box.margin = margin(0, 10, 0, 10), legend.margin = margin(0), plot.margin = unit(c(0, 5.5, 5.5, 5.5), "pt")) +
    geom_smooth(se = F, span = 1, linewidth = 0.75) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000"), labels = 1:5) +
    labs(x = "Number of Probes", y = "Theoretical Specificity (%)", color = "Copy Number") +
    scale_x_continuous(limits = c(4,24), breaks = seq(4,24,2)) +
    scale_y_continuous(limits = c(15, 100), expand = c(0,0,0,1))
```

### 3 Component Model

```{r}
control.copy.number <- generateControlCopyNumberTemplate(exp1, copy.number = 2, "RPE1")
control.copy.number["chr10q", "copy.number"] <- 3
exp1.3comp <- calcGMMCopyNumber(exp1, cell.barcodes = rpe1.bcs, control.copy.number = control.copy.number, model.components = 1:3)
exp1.gmm.metrics.3 <- calcTruePosRate(exp1.3comp, "chr") %>% filter(cn.sim.class != "sim_cn6")
exp1.gmm.metrics.3 <- exp1.gmm.metrics.3 %>% left_join(n.probes, by = "feature.id")
exp1.gmm.metrics.3 <- exp1.gmm.metrics.3 %>% mutate(false.neg.p = false.neg.p * 100, true.pos.p = true.pos.p * 100)
```

```{r}
exp1.gmm.metrics.3.avg <- exp1.gmm.metrics.3 %>% group_by(cn.sim.class) %>% summarize(mean.tpr = mean(true.pos.p), .groups = "drop") %>% print()
```

```{r}
ggplot(exp1.gmm.metrics.3, aes(x = feature.id, y = true.pos.p)) +
    geom_col(aes(fill = cn.sim.class), color = "black", width = 0.85) +
    facet_wrap(cn.sim.class ~., ncol = 1) +
    theme_classic_custom +
    theme(legend.position = "none", panel.grid.major.y = element_line(), 
          strip.background = element_blank()) +
    scale_fill_manual(values = c("#785EF0", "#648FFF", "#DC267F")) +
    labs(x = "Chromosome", y = "Theoretical Sensitivity (%)") +
    scale_y_continuous(breaks = c(0, 50, 100), expand = c(0,0,0,0)) +
    geom_text(aes(label=round(true.pos.p,0)), vjust = -1, size = 6/.pt) +
    geom_text(data = exp1.gmm.metrics.3.avg, aes(label = glue::glue("avg: {round(mean.tpr, 0)}%"), x = 22, y = 140), size = 6/.pt, inherit.aes = F)
```

```{r}
ggplot(exp1.gmm.metrics.3, aes(x=n.probes, y=true.pos.p, color = cn.sim.class)) +
    geom_point(alpha = 0.5, position = position_jitter(width = 0.25)) + 
    theme_classic_custom +
    theme(legend.position = "top", panel.grid.major = element_line()) +
    theme(legend.box.margin = margin(0, 10, 0, 10), legend.margin = margin(0), plot.margin = unit(c(0, 5.5, 5.5, 5.5), "pt")) +
    geom_smooth(se = F, span = 1, linewidth = 0.75) +
    geom_smooth(data = rpe1.data.results, aes(x=n.probes, y=pct.concordance), linewidth = 0.75,
                color = "black", inherit.aes = F, se = F, span = 1, linetype = "dashed", alpha = 0.5) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F"), labels = 1:3) +
    labs(x = "Number of Probes", y = "Theoretical Sensitivity (%)", color = "Copy Number") +
    scale_x_continuous(limits = c(4,25), breaks = seq(4,24,2)) +
    scale_y_continuous(limits = c(15, 110), expand = c(0,0,0,1))
```

```{r}
exp1.gmm.metrics.3.spec <- calcTrueNegRate(exp1.3comp) %>% mutate(tnr = tnr * 100)
exp1.gmm.metrics.3.spec <- exp1.gmm.metrics.3.spec %>% left_join(n.probes, by = "feature.id")

ggplot(exp1.gmm.metrics.3.spec, aes(x = feature.id, y = tnr)) +
    geom_col(aes(fill = cn.sim.class), color = "black", width = 0.85) +
    facet_wrap(cn.sim.class ~., ncol = 1) +
    theme_classic_custom +
    theme(legend.position = "none", panel.grid.major.y = element_line(), 
          strip.background = element_blank()) +
    scale_fill_manual(values = c("#785EF0", "#648FFF", "#DC267F")) +
    labs(x = "Chromosome", y = "Theoretical Specificity (%)") +
    scale_y_continuous(breaks = c(0, 50, 100), expand = c(0,0,0,25)) +
    geom_text(aes(label=round(tnr,0)), vjust = -1, size = 6/.pt)
```

```{r}
ggplot(exp1.gmm.metrics.3.spec, aes(x=n.probes, y=tnr, color = cn.sim.class)) +
    geom_point(alpha = 0.5, position = position_jitter(width = 0.25)) + 
    theme_classic_custom +
    theme(legend.position = "top", panel.grid.major = element_line()) +
    theme(legend.box.margin = margin(0, 10, 0, 10), legend.margin = margin(0), plot.margin = unit(c(0, 5.5, 5.5, 5.5), "pt")) +
    geom_smooth(se = F, span = 1, linewidth = 0.75) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F"), labels = 1:5) +
    labs(x = "Number of Probes", y = "Theoretical Specificity (%)", color = "Copy Number") +
    scale_x_continuous(limits = c(4,24.5), breaks = seq(4,24,2)) +
    scale_y_continuous(limits = c(75, 100), expand = c(0,0,0,1))
```

#### GMM Plots

```{r}
gmm1.3comp <- plotCopyNumberGMM(exp1.3comp, feature.id = 1, draw.boundaries = T) +     
    theme_classic_custom +
    theme(legend.position = "none", panel.grid.minor = element_blank(), panel.grid.major.y = element_blank(),
          plot.margin = unit(c(0, 0, 5.5, 5.5), "pt"), axis.title.x = element_blank()) + 
    labs(title = NULL, color = "Copy Number Component") +
    scale_y_continuous(expand = c(0,0,0,0.05)) +
    scale_x_continuous(expand = c(0,0,0,0), breaks = 1:7, limits = c(0, 7)) +
    annotate("text", x = 6.5, y = 0.95, label = "Chr 1", size = 7/.pt) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F"))

gmm2.3comp <- plotCopyNumberGMM(exp1.3comp, feature.id = 13, draw.boundaries = T) +
        theme_classic_custom +
        theme(legend.position = "none", panel.grid.minor = element_blank(), panel.grid.major.y = element_blank(),
          plot.margin = unit(c(0, 5.5, 5.5, 0), "pt"), axis.title = element_blank(), axis.text.y = element_blank()) + 
    labs(title = NULL, color = "Copy Number Component") +
    scale_y_continuous(expand = c(0,0,0,0.05)) +
    scale_x_continuous(expand = c(0,0,0,0), breaks = 1:7, limits = c(0, 7)) +
        annotate("text", x = 6.5, y = 0.95, label = "Chr 13", size = 7/.pt) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F"))

gmm3.3comp <- plotCopyNumberGMM(exp1.3comp, feature.id = 22, draw.boundaries = T) +
        theme_classic_custom +
        theme(legend.position = "none", panel.grid.minor = element_blank(), panel.grid.major.y = element_blank(),
          plot.margin = unit(c(0, 0, 5.5, 5.5), "pt")) + 
    labs(title = NULL, color = "Copy Number Component", x = "Copy Number Score") +
    scale_y_continuous(expand = c(0,0,0,0.05)) +
    scale_x_continuous(expand = c(0,0,0,0), breaks = 1:7, limits = c(0, 7)) +
    annotate("text", x = 6.5, y = 0.95, label = "Chr 22", size = 7/.pt) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F"))

gmm4.3comp <- plotCopyNumberGMM(exp1.3comp, feature.id = "X", draw.boundaries = T) +
        theme_classic_custom +
    theme(legend.position = "none", panel.grid.minor = element_blank(), panel.grid.major.y = element_blank(),
          plot.margin = unit(c(0, 5.5, 5.5, 0), "pt"), axis.text.y = element_blank(), axis.title.y = element_blank()) + 
    labs(title = NULL, color = "Copy Number Component", x = "Copy Number Score") +
    scale_y_continuous(expand = c(0,0,0,0.05)) +
    scale_x_continuous(expand = c(0,0,0,0), breaks = 1:7, limits = c(0, 7)) +
    annotate("text", x = 6.5, y = 0.95, label = "Chr X", size = 7/.pt) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F"))

gmm.legend.3comp <- get_legend(gmm1.3comp + theme(legend.box.margin = margin(0, 0, 5, 0), legend.position = "top") + guides(color = guide_legend(nrow = 1)))

gmm.grid.1.3comp <- plot_grid(plotlist = list(gmm1.3comp, gmm2.3comp, gmm3.3comp, gmm4.3comp), ncol = 2, align = "hv", axis = "lrtb")
gmm.example.plot.3comp <- plot_grid(plotlist = list(gmm.legend.3comp, gmm.grid.1.3comp), ncol = 1, rel_heights = c(0.2, 1))
gmm.example.plot.3comp
```

## Chr Arms

### Bar Chart

```{r}
rpe1.data.arm <- getTidyData(exp1, "smoothedCopyNumberByArm", "gmmCopyNumber") %>% filter(cluster == "RPE1") %>% select(!c("total.reads", "cluster"))
rpe1.data.arm$known.ploidy <- 2
rpe1.data.arm[which(rpe1.data.arm$feature.id == "chr10q"), "known.ploidy"] <- 3

rpe1.data.arm.results <- rpe1.data.arm %>% group_by(cell.barcode, feature.id) %>% summarize(cn.concordance = gmmCopyNumber == known.ploidy) %>% group_by(feature.id) %>% dplyr::count(cn.concordance) %>% mutate(pct.concordance = round(n*100/sum(n), 1)) %>% filter(cn.concordance == TRUE) %>% print()

n.probes.arm <- fct_count(rowData(exp1)$arm)
colnames(n.probes.arm) <- c("feature.id", "n.probes")
rpe1.data.arm.results <- rpe1.data.arm.results %>% left_join(n.probes.arm, by = "feature.id")
```

```{r}
sum(rpe1.data.arm.results$pct.concordance >=75.0)
nrow(rpe1.data.arm.results)
```

```{r}
rpe1.data.arm.results$feature.label <- rpe1.data.arm.results$feature.id %>% str_sub(4,-1)
```

```{r}
arm.sensitivity <- 
rpe1.data.arm.results %>% 
    ggplot(aes(x=feature.id, y=pct.concordance)) +
    geom_col(color = "black", fill = "#7EBDC3", width = 0.75) +
    coord_cartesian(ylim = c(0,100)) +
    scale_y_continuous(expand = c(0,0), breaks = seq(0,100,20), minor_breaks = seq(0,100,10)) +
    labs(y = "Sensitivity (%)", x = "Chromosome Arm") +
    geom_text(aes(label=round(pct.concordance,0)), vjust = -1, size = 7/.pt) +
    theme_bw_custom +
    theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(hjust = 1, angle = 45), axis.line = element_line(), panel.border = element_blank()) +
    geom_hline(yintercept = mean(rpe1.data.arm.results$pct.concordance), linetype = "dashed", alpha = 0.7) +
    annotate("text", x = 39, y = 95, size = 7/.pt, label = paste0("avg: ", round(mean(rpe1.data.arm.results$pct.concordance), 0), "%")) +
    scale_x_discrete(labels = rpe1.data.arm.results$feature.label)
arm.sensitivity
```

```{r}
saveRDS(arm.sensitivity, file = here("figures", "figure-c", "exp01.rpe1.accuracy.arm.RDS"))
```

#### Cross Validation

```{r}
exp1.cv <- exp1
control.copy.number <- generateControlCopyNumberTemplate(exp1, copy.number = 2, "RPE1")
control.copy.number["chr10q", "copy.number"] <- 3
```

```{r}
cv.results.arms <- map(levels(cv.folds$cv.fold), function(x){
    
    training.bcs <- cv.folds %>% filter(cv.fold != x) %>% pull(cell.barcode)
    exp1.cv <- suppressMessages(calcGMMCopyNumber(exp1.cv, cell.barcodes = training.bcs, control.copy.number = control.copy.number))
    
    rpe1.cv.data <- getTidyData(exp1.cv, "smoothedCopyNumberByArm", "gmmCopyNumber") %>% filter(cluster == "RPE1", !cell.barcode %in% training.bcs) %>% select(!c("total.reads", "cluster"))
    rpe1.cv.data$known.ploidy <- 2
    rpe1.cv.data$known.ploidy[rpe1.cv.data$feature.id == "chr10q"] <- 3
    rpe1.cv.data.results.arms <- rpe1.cv.data %>% group_by(cell.barcode, feature.id) %>% summarise(cn.concordance = gmmCopyNumber == known.ploidy, .groups = "drop") %>% group_by(feature.id) %>% dplyr::count(cn.concordance) %>% mutate(pct.concordance = round(n*100/sum(n), 1)) %>% filter(cn.concordance == TRUE) %>% add_column(test.fold = x)
    
}) %>% list_rbind() %>% left_join(n.probes.arm, by = "feature.id")
cv.results.arms$feature.label <- cv.results.arms$feature.id %>% str_sub(4,-1)
```

```{r}
cv.results.arms %>% 
    ggplot(aes(x = feature.id, y = pct.concordance)) +
    ggdist::stat_pointinterval(.width = c(1), linewidth = 2, point_size = 1, point_interval = "mean_qi") + 
    geom_point(position = position_nudge(x=-0.3), alpha = 0.5, size = 1) +
    geom_point(data = rpe1.data.arm.results, aes(x=feature.id, y=pct.concordance), inherit.aes = F, pch = 4, color = "red", position = position_nudge(x=0.3)) +
    theme_bw_custom +
    scale_y_continuous(limits = c(34, 100)) +
    labs(y = "Sensitivity (%)", x = "Chromosome") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    scale_x_discrete(labels = cv.results.arms$feature.label)
```

```{r}
arm.sensitivity.mad <- 
cv.results.arms %>% group_by(feature.id, feature.label) %>% summarize(mean.pct = mean(pct.concordance), mad = mad(pct.concordance), mean.ad = DescTools::MeanAD(pct.concordance), .groups = "drop") %>% print() %>% 
    ggplot(aes(x = feature.id, y = mean.pct)) + 
    ggdist::geom_pointinterval(aes(ymin = mean.pct - mean.ad, ymax = mean.pct + mean.ad)) +
    theme_classic_custom + 
    theme(panel.grid.major = element_line(), axis.text.x = element_text(angle = 45, hjust = 1)) +
    scale_y_continuous(limits = c(30, 100), expand = c(0,0,0,0), breaks = seq(30, 100, 10)) +
    scale_x_discrete(labels = cv.results.arms$feature.label) +
    labs(y = "Sensitivity (%)", x = "Chromosome Arm") + 
    geom_hline(yintercept = mean(cv.results.arms$pct.concordance), linetype = "dashed", alpha = 0.7) +
    annotate("text", x = 40, y = 95, size = 7/.pt, label = paste0("avg: ", round(mean(cv.results.arms$pct.concordance), 0), "%"))
arm.sensitivity.mad
```

```{r}
saveRDS(arm.sensitivity.mad, file = here("figures", "figure-c", "exp01.rpe1.accuracy.arm.mad.RDS"))
```

### Empirical Sensitivity for Cancer Cell CNVs

Assuming that CNVs are clonal, what is the sensitivity for detection of CNVs in cancer cell lines, and do they match up with theoretical sensitivity expectations?

LS513 - 1q, 5, 7, 9, 13x2, XY
LoVo - 5p, 7, 12, 15, XY
CL11 - -6, 7x2, -18, XY
SW48 - 7, 14

```{r}
exp1.tpr.arm <- calcTruePosRate(exp1, "arm") %>%  select(feature.id, cn.sim.class, true.pos.p)
exp1.tpr.arm$feature.id <- as.character(exp1.tpr.arm$feature.id)
exp1.tpr.arm$true.pos.p <- round(exp1.tpr.arm$true.pos.p * 100,1)
exp1.tpr.arm$cn.sim.class <- factor(exp1.tpr.arm$cn.sim.class, levels = levels(exp1.tpr.arm$cn.sim.class), labels = c(1:6))
exp1.tpr.arm$cn.sim.class <- as.numeric(as.character(exp1.tpr.arm$cn.sim.class))
colnames(exp1.tpr.arm)[2:3] <- c("event", "sensitivity.sim")
```

```{r}
empirical.sim.comparison.arm <- function(cell.data, cell.lut){
    
    cell.data <- cell.data %>% filter(feature.id %in% cell.lut$feature.id) %>% left_join(cell.lut, by = 'feature.id') %>% mutate(known.cn = ifelse(is.na(known.cn), 2, known.cn)) %>% mutate(feature.id = factor(feature.id, labels = unique(cell.lut$feature.id)))
    
    cell.data.results <- cell.data %>% group_by(cell.barcode, feature.id) %>% summarise(cn.concordance = gmmCopyNumber == known.cn, .groups = "drop") %>% group_by(feature.id) %>% dplyr::count(cn.concordance) %>% mutate(sensitivity.emp = round(n*100/sum(n), 1)) %>% filter(cn.concordance == TRUE) %>% select(feature.id, n, sensitivity.emp) %>% left_join(cell.lut, by = "feature.id")
    
    cell.data.results %>% left_join(exp1.tpr.arm, by = c("known.cn" = "event", "feature.id")) %>% select(feature.id, known.cn, sensitivity.emp, sensitivity.sim)
    
}
```


```{r}
ls513.data.arm <- getTidyData(exp1, "smoothedCopyNumberByArm", "gmmCopyNumber") %>% filter(cluster == "LS513") %>% select(!c("total.reads", "cluster"))

ls513.lut.arm <- data.frame(feature.id = c("chr1p", "chr1q"),
                        known.cn = c(2,3))

empirical.sim.comparison.arm(ls513.data.arm, ls513.lut.arm)
```

```{r}
lovo.data.arm <- getTidyData(exp1, "smoothedCopyNumberByArm", "gmmCopyNumber") %>% filter(cluster == "LoVo") %>% select(!c("total.reads", "cluster"))

lovo.arm.lut <- data.frame(feature.id = c("chr5p", "chr5q"),
                        known.cn = c(3,2))

empirical.sim.comparison.arm(lovo.data.arm, lovo.arm.lut)

```

```{r}
empirical.sensitivity.list$ls513.arm <- empirical.sim.comparison.arm(ls513.data.arm, ls513.lut.arm)
empirical.sensitivity.list$lovo.arm <- empirical.sim.comparison.arm(lovo.data.arm, lovo.arm.lut)
```

```{r}
saveRDS(empirical.sensitivity.list, file = here("datasets", "cellline.empirical.sim.comparison.RDS"))
```


### Linear Regression

```{r}
saveRDS(rpe1.data.arm.results, file = here("datasets", "rpe1.arm.accuracy.rates.RDS"))
```

```{r}
mod.arm <- lm(pct.concordance ~ log(n.probes), rpe1.data.arm.results)
summary(mod.arm)
plot(mod.arm$residuals) 
plot(density(mod.arm$residuals))
rsq.arm <- summary(mod.arm)$r.squared %>% round(.,2) %>% paste0("R-sq: ", .) %>% print()
```

```{r}
arm.sens.lm <-
ggplot(rpe1.data.arm.results, aes(x=n.probes, y=pct.concordance)) +
    geom_smooth(method = "lm", se = F, color = "#7EBDC3") + 
    geom_point() +
    ggrepel::geom_text_repel(aes(label = feature.label), max.overlaps = Inf, min.segment.length = 0.3, size = 7/.pt) + 
    labs(y= "Sensitivity (%)", x = "Number of Probes per Chromosome Arm") +
    theme_classic_custom + 
    theme(panel.grid.major = element_line(),
          axis.ticks.x.bottom = element_line()) +
    scale_x_continuous(trans = "log", limits = c(4,15), breaks = seq(1,15,1)) +
    scale_y_continuous(limits = c(30,100), expand = c(0,0,0,0)) +
    annotate("text", x = 4.1, y = 97, hjust = 0, label = rsq.arm, size = 6/.pt)
arm.sens.lm
```

```{r}
saveRDS(arm.sens.lm, file = here("figures", "figure-c", "exp01.rpe1.accuracy.arm.regression.RDS"))
```

```{r}
cv.results.summary.arms <- cv.results.arms %>% group_by(feature.id, n.probes) %>% summarize(mean.pct = mean(pct.concordance), .groups = "drop")
cv.results.summary.arms$feature.label <- cv.results.summary.arms$feature.id %>% str_sub(4,-1)
```

```{r}
mod2 <- (lm(mean.pct ~ log(n.probes), cv.results.summary.arms))
plot(mod2$residuals) 
plot(density(mod2$residuals))
summary(mod2)
rsq2.arm <- summary(mod2)$r.squared %>% round(.,2) %>% paste0("R-sq: ", .) %>% print()
```

```{r}
ggplot(cv.results.summary.arms, aes(x=n.probes, y=mean.pct)) +
    geom_smooth(method = "lm", se = F, color = "#7EBDC3") + 
    geom_point() +
    ggrepel::geom_text_repel(aes(label = feature.label), max.overlaps = Inf, min.segment.length = 0.3, size = 7/.pt) + 
    labs(y= "Mean Sensitivity (%)", x = "Number of Probes per Chromosome Arm") +
    theme_classic_custom + 
    theme(panel.grid.major = element_line(),
          axis.ticks.x.bottom = element_line()) +
    scale_x_continuous(trans = "log", limits = c(4,15), breaks = seq(1,15,1)) +
    scale_y_continuous(limits = c(30,100), expand = c(0,0,0,0)) +
    annotate("text", x = 4.1, y = 97, hjust = 0, label = rsq2.arm, size = 6/.pt)
```

### Theoretical Sensitivity

```{r}
exp1.gmm.metrics.arm <- calcTruePosRate(exp1, "arm") %>% filter(cn.sim.class != "sim_cn6")
exp1.gmm.metrics.arm <- exp1.gmm.metrics.arm %>% left_join(n.probes.arm, by = "feature.id")
exp1.gmm.metrics.arm <- exp1.gmm.metrics.arm %>% mutate(false.neg.p = false.neg.p * 100, true.pos.p = true.pos.p * 100)
```

```{r}
exp1.gmm.metrics.arm.avg <- exp1.gmm.metrics.arm %>% group_by(cn.sim.class) %>% summarize(mean.tpr = mean(true.pos.p), .groups = "drop") %>% print()
```

```{r}
tpr.arm.bars <- 
ggplot(exp1.gmm.metrics.arm, aes(x = feature.id, y = true.pos.p)) +
    geom_col(aes(fill = cn.sim.class), color = "black", width = 0.75) +
    facet_wrap(cn.sim.class ~., ncol = 1) +
    theme_classic_custom +
    theme(legend.position = "none", panel.grid.major.y = element_line(),
          strip.background = element_blank(), 
          axis.text.x = element_text(angle = 45, hjust=1)) +
    scale_fill_manual(values = c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000")) +
    labs(x = "Chromosome Arm", y = "Theoretical Sensitivity (%)") +
    scale_y_continuous(breaks = c(0, 50, 100), expand = c(0,0,0,0)) +
    scale_x_discrete(labels = rpe1.data.arm.results$feature.label) +
    geom_text(aes(label=round(true.pos.p,0)), vjust = -1, size = 6/.pt) +
    geom_text(data = exp1.gmm.metrics.arm.avg, aes(label = glue::glue("avg: {round(mean.tpr, 0)}%"), x = 38, y = 140), size = 6/.pt, inherit.aes = F)
tpr.arm.bars
```

```{r}
saveRDS(tpr.arm.bars, file = here("figures", "figure-c", "exp01.arm.theoretical.tpr.bars.RDS"))
```

```{r}
tpr.arm.nprobes <- 
ggplot(exp1.gmm.metrics.arm, aes(x=n.probes, y=true.pos.p, color = cn.sim.class)) +
    geom_point(alpha = 0.5, position = position_jitter(width = 0.25)) + 
    theme_classic_custom +
    theme(legend.position = "top", panel.grid.major = element_line()) +
    theme(legend.box.margin = margin(0, 10, 0, 10), legend.margin = margin(0), plot.margin = unit(c(0, 5.5, 5.5, 5.5), "pt")) +
    geom_smooth(se = F, span = 1, linewidth = 0.75) +
    geom_smooth(data = rpe1.data.arm.results, aes(x=n.probes, y=pct.concordance), 
                color = "black", inherit.aes = F, se = F, span = 1, linetype = "dashed", linewidth = 0.75) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000"), labels = 1:5) +
    labs(x = "Number of Probes", y = "Theoretical Sensitivity (%)", color = "Copy Number") +
    scale_x_continuous(limits = c(4,14), breaks = seq(4,14,2)) +
    scale_y_continuous(limits = c(15, 100), expand = c(0,0,0,0))
tpr.arm.nprobes
```

```{r}
saveRDS(tpr.arm.nprobes, file = here("figures", "figure-c", "exp01.arm.theoretical.tpr.RDS"))
```

Correlation between theoretical true positive rate and actual true positive rate is high.

```{r}
combined.data <- inner_join(exp1.gmm.metrics.arm, rpe1.data.arm.results, by = "feature.id") %>% filter(cn.sim.class == "sim_cn2")
cor(combined.data$pct.concordance, combined.data$true.pos.p)
```

```{r}
saveRDS(exp1.gmm.metrics.arm, file = here("datasets", "exp1.gmm.metrics.arms.RDS"))
```

### Specificity

true neg / (true neg + false pos)

there are no true negatives or false positives for CN = 2

```{r}
exp1.gmm.specificity.arm <- calcTrueNegRate(exp1, chromosome.scope = "arm") %>% mutate(tnr = tnr * 100) %>% filter(cn.sim.class != "sim_cn6")
exp1.gmm.specificity.arm <- exp1.gmm.specificity.arm %>% left_join(n.probes.arm, by = "feature.id")

ggplot(exp1.gmm.specificity.arm, aes(x = feature.id, y = tnr)) +
    geom_col(aes(fill = cn.sim.class), color = "black", width = 0.85) +
    facet_wrap(cn.sim.class ~., ncol = 1) +
    theme_classic_custom +
    theme(legend.position = "none", panel.grid.major.y = element_line(), 
          strip.background = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1)) +
    scale_fill_manual(values = c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000")) +
    labs(x = "Chromosome", y = "Theoretical Specificity (%)") +
    scale_y_continuous(breaks = c(0, 50, 100), expand = c(0,0,0,25)) +
    geom_text(aes(label=round(tnr,0)), vjust = -1, size = 6/.pt)
```

```{r}
ggplot(exp1.gmm.specificity.arm, aes(x=n.probes, y=tnr, color = cn.sim.class)) +
    geom_point(alpha = 0.5, position = position_jitter(width = 0.25)) + 
    theme_classic_custom +
    theme(legend.position = "top", panel.grid.major = element_line()) +
    theme(legend.box.margin = margin(0, 10, 0, 10), legend.margin = margin(0), plot.margin = unit(c(0, 5.5, 5.5, 5.5), "pt")) +
    geom_smooth(se = F, span = 1, linewidth = 0.75) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000"), labels = 1:5) +
    labs(x = "Number of Probes", y = "Theoretical Specificity (%)", color = "Copy Number") +
    scale_y_continuous(limits = c(15, 100), expand = c(0,0,0,1))
```

### 3 Component

```{r}
exp1.gmm.metrics.arm.3comp <- calcTruePosRate(exp1.3comp, "arm")
exp1.gmm.metrics.arm.3comp <- exp1.gmm.metrics.arm.3comp %>% left_join(n.probes.arm, by = "feature.id")
exp1.gmm.metrics.arm.3comp <- exp1.gmm.metrics.arm.3comp %>% mutate(false.neg.p = false.neg.p * 100, true.pos.p = true.pos.p * 100)
exp1.gmm.metrics.arm.3comp$feature.label <- exp1.gmm.metrics.arm.3comp$feature.id %>% str_sub(4,-1)
```

```{r}
exp1.gmm.metrics.arm.avg.3comp <- exp1.gmm.metrics.arm.3comp %>% group_by(cn.sim.class) %>% summarize(mean.tpr = mean(true.pos.p), .groups = "drop") %>% print()
```

```{r}
ggplot(exp1.gmm.metrics.arm.3comp, aes(x = feature.id, y = true.pos.p)) +
    geom_col(aes(fill = cn.sim.class), color = "black", width = 0.75) +
    facet_wrap(cn.sim.class ~., ncol = 1) +
    theme_classic_custom +
    theme(legend.position = "none", panel.grid.major.y = element_line(),
          strip.background = element_blank(), 
          axis.text.x = element_text(angle = 45, hjust=1)) +
    scale_fill_manual(values = c("#785EF0", "#648FFF", "#DC267F")) +
    labs(x = "Chromosome Arm", y = "Theoretical Sensitivity (%)") +
    scale_y_continuous(breaks = c(0, 50, 100), expand = c(0,0,0,0)) +
    scale_x_discrete(labels = exp1.gmm.metrics.arm.3comp$feature.label) +
    geom_text(aes(label=round(true.pos.p,0)), vjust = -1, size = 6/.pt) +
    geom_text(data = exp1.gmm.metrics.arm.avg.3comp, aes(label = glue::glue("avg: {round(mean.tpr, 0)}%"), x = 38, y = 120), size = 6/.pt, inherit.aes = F)
```

```{r}
ggplot(exp1.gmm.metrics.arm.3comp, aes(x=n.probes, y=true.pos.p, color = cn.sim.class)) +
    geom_point(alpha = 0.5, position = position_jitter(width = 0.25)) + 
    theme_classic_custom +
    theme(legend.position = "top", panel.grid.major = element_line()) +
    theme(legend.box.margin = margin(0, 10, 0, 10), legend.margin = margin(0), plot.margin = unit(c(0, 5.5, 5.5, 5.5), "pt")) +
    geom_smooth(se = F, span = 1, linewidth = 0.75) +
    geom_smooth(data = rpe1.data.arm.results, aes(x=n.probes, y=pct.concordance), 
                color = "black", inherit.aes = F, se = F, span = 1, linetype = "dashed", linewidth = 0.75) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F", "#FE6100", "#FFB000"), labels = 1:5) +
    labs(x = "Number of Probes", y = "Theoretical Sensitivity (%)", color = "Copy Number") +
    scale_x_continuous(limits = c(3.5,14.5), breaks = seq(4,14,2)) +
    scale_y_continuous(limits = c(15, 100), expand = c(0,0,0,0))
```

```{r}
exp1.gmm.specificity.arm.3comp <- calcTrueNegRate(exp1.3comp, chromosome.scope = "arm") %>% mutate(tnr = tnr * 100)
exp1.gmm.specificity.arm.3comp <- exp1.gmm.specificity.arm.3comp %>% left_join(n.probes.arm, by = "feature.id")

ggplot(exp1.gmm.specificity.arm.3comp, aes(x = feature.id, y = tnr)) +
    geom_col(aes(fill = cn.sim.class), color = "black", width = 0.85) +
    facet_wrap(cn.sim.class ~., ncol = 1) +
    theme_classic_custom +
    theme(legend.position = "none", panel.grid.major.y = element_line(), 
          strip.background = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1)) +
    scale_fill_manual(values = c("#785EF0", "#648FFF", "#DC267F")) +
    labs(x = "Chromosome", y = "Theoretical Specificity (%)") +
    scale_y_continuous(breaks = c(0, 50, 100), expand = c(0,0,0,25)) +
    scale_x_discrete(labels = exp1.gmm.metrics.arm.3comp$feature.label) +
    geom_text(aes(label=round(tnr,0)), vjust = -1, size = 6/.pt)
```

```{r}
ggplot(exp1.gmm.specificity.arm.3comp, aes(x=n.probes, y=tnr, color = cn.sim.class)) +
    geom_point(alpha = 0.5, position = position_jitter(width = 0.25)) + 
    theme_classic_custom +
    theme(legend.position = "top", panel.grid.major = element_line()) +
    theme(legend.box.margin = margin(0, 10, 0, 10), legend.margin = margin(0), plot.margin = unit(c(0, 5.5, 5.5, 5.5), "pt")) +
    geom_smooth(se = F, span = 1, linewidth = 0.75) +
    scale_color_manual(values = c("#785EF0", "#648FFF", "#DC267F"), labels = 1:3) +
    labs(x = "Number of Probes", y = "Theoretical Specificity (%)", color = "Copy Number") +
    scale_y_continuous(limits = c(70, 100), expand = c(0,0,0,1))
```

## Length and Density

```{r}
chr.lengths <- read.table(here("datasets", "hg19-chromosome-lengths.txt"), sep = '\t', header = T)
chr.lengths$chrom <- str_sub(chr.lengths$chrom, start = 4, end = -1)
chr.lengths$chrom[which(chr.lengths$chrom == '24')] <- "X"
```

```{r}
chr.lengths <- chr.lengths %>% inner_join(rpe1.data.results, by = c("chrom" = "feature.id")) %>% filter(chrom != 10)
chr.lengths$chrom <- factor(chr.lengths$chrom, levels = unique(chr.lengths$chrom))
chr.lengths <- chr.lengths %>% mutate(probe.density = 10^8 * n.probes / length.bp)
```

```{r}
length.corr <- cor(chr.lengths$length.bp, chr.lengths$pct.concordance)
```

```{r}
n.probe.length.corr <- cor(chr.lengths$length.bp, chr.lengths$n.probes)
```

```{r}
chr.length.sensitivity <- 
ggplot(chr.lengths, aes(x=length.bp/10^8, y=pct.concordance)) +
    geom_smooth(method = "lm", se = F, color = "#C6DEA6") + 
    geom_point() +
    ggrepel::geom_text_repel(aes(label = chrom), max.overlaps = 12, size = 7/.pt) + 
    labs(y= "Sensitivity (%)", x = "Chromosome Length (100 MB)") +
    theme_classic_custom + 
    theme(panel.grid.major = element_line()) +
    scale_y_continuous(limits = c(30,100), expand = c(0,0,0,0)) +
    annotate("text", x = 2.48, y = 37, size = 7/.pt, hjust = 1, label = paste0("Chr Length vs Sensitivity, Pearson r = ", round(length.corr, 2))) +
    annotate("text", x = 2.48, y = 32, size = 7/.pt, hjust = 1, label = paste0("Chr Length vs No. of Probes, Pearson r = ", round(n.probe.length.corr, 2)))
chr.length.sensitivity
```

```{r}
saveRDS(chr.length.sensitivity, file = here("figures", "figure-c", "exp01.rpe1.accuracyVsLength.RDS"))
```

```{r}
density.corr <- cor(chr.lengths$probe.density, chr.lengths$pct.concordance)
```

```{r}
ggplot(chr.lengths, aes(x=probe.density, y=pct.concordance)) +
    geom_smooth(method = "lm", se = F, color = "#785EF0") + 
    geom_point() +
    ggrepel::geom_text_repel(aes(label = chrom), max.overlaps = 12) + 
    labs(y= "Accuracy (%)", x = "Probe Density (per 100 MB)", title = "Probe Density vs Accuracy") +
    theme_classic() + 
    theme(panel.grid.major = element_line()) +
    scale_y_continuous(limits = c(30,100)) +
    scale_x_continuous(limits = c(8,25)) +
    annotate("text", x = 24.8, y = 97, hjust = 1, label = paste0("Pearson r = ", round(density.corr, 2)))
```

## Beta Regression

Beta model is a generally more appropirate model because Y is bound between 0 and 1 (0% and 100%), but the segment of the curve we are modeling is linear enough that the linear model can be used as an approximation that is easier to understand. 

```{r}
plot(density(rpe1.data.results$pct.concordance))
```

```{r}
rpe1.data.results$pct.concordance.scale <- rpe1.data.results$pct.concordance / 100
bm <- betareg::betareg(data = rpe1.data.results, pct.concordance.scale ~ n.probes)
```

```{r}
summary(bm)
```

```{r}
plot(bm)
plot(bm,which=5,type="deviance",sub.caption="")
```

```{r}
beta.fitted <- enframe(fitted(bm), name = NULL, value = "pct.concordance")
beta.fitted$n.probes <- bm$model$n.probes
beta.fitted$pct.concordance <- beta.fitted$pct.concordance * 100
```

```{r}
beta.predict <- data.frame(n.probes = seq(1,60,0.5))
beta.predict$pct.concordance <- predict(bm, newdata = beta.predict)
beta.predict$pct.concordance <- beta.predict$pct.concordance * 100
```

Logit (link function) on Y needs to be rearranged in terms of Y, with coefficients from regression. 
```{r}
beta.manual <- data.frame(n.probes = seq(1,60,0.5))
beta.manual$pct.concordance <- exp(-0.31385 + (0.12679 * beta.manual$n.probes)) / (1 + exp(-0.31385 + (0.12679 * beta.manual$n.probes)))
beta.manual$pct.concordance <- beta.manual$pct.concordance * 100
```

```{r}
plot(beta.manual$pct.concordance, beta.predict$pct.concordance)
```

```{r}
ggplot(rpe1.data.results, aes(x=n.probes, y=pct.concordance)) +
    geom_point() +
    geom_smooth(method = "lm", se = F, color = "#785EF0") + 
    ggrepel::geom_text_repel(aes(label = feature.id), max.overlaps = 5, point.padding = 5) + 
    labs(y= "Sensitivity (%)", x = "Number of Probes per Chromosome") +
    theme_classic() + 
    theme(panel.grid.major = element_line()) +
    scale_y_continuous(limits = c(30,100)) +
    scale_x_continuous(trans = "log", limits = c(4,60), breaks = seq(4,60,4)) +
    geom_line(data = beta.predict, color = "red", linewidth = 0.7, alpha = 0.7)
```




# session_info

```{r}
sessioninfo::session_info()
```